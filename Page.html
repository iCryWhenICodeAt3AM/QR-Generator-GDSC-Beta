<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Code Styling</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      #message{
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #canvas {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Optionally, set the desired height */
      }
    </style>
</head>
<body>
   <h1 id="message"></h1>
    <div id="canvas"></div>
    <script type="text/javascript">
    // page onLoad preparation
    google.script.run.withSuccessHandler(() => generateQR(counter)).doGet();

    let counter = 0;
    let data = "<?= data ?>";
    // Split the input into an array
    var pairs = data.split(',');

    // Create an array of objects for Name and Code pairs
    var dataArray = [];

    for (var i = 0; i < pairs.length; i += 3) {
        var name = pairs[i];
        var code = pairs[i + 1];
        var row = pairs[i + 2];
        dataArray.push({ Name: name, Code: code, Row: row });
    }

    function waitForCanvasToLoad(callback) {
          var interval = setInterval(function() {
              var canvasElement = document.querySelector("#canvas canvas");
              if (canvasElement) {
                  clearInterval(interval); // Stop checking
                  callback(canvasElement);
              }
          }, 100); // Check every 100 milliseconds
      }


    function generateQR() {
      $('#message').text("SAVING TO DRIVE AS "+dataArray[counter].Name);
      $('#canvas').css('border-color', 'red');
      $('#canvas').empty();
      // console.log(dataArray);
      const qrCode = new QRCodeStyling({
        width: 600,
        height: 600,
        type: "canvas",
        data: ""+dataArray[counter].Code, // Use the counter to dynamically access data
        image: "https://i.ibb.co/ZzBFw8k/birb.png",
        dotsOptions: {
          color: "#000000",
          type: "dots"
        },
        cornersSquareOptions:{
            type:"square"
        },
        cornersDotOptions:{
            type:"square"
        },
        backgroundOptions: {
          color: "#ffffff",
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 10
        },
        cornersSquareOptions:{
            type:"extra-rounded",
            color:"#000000"
          },
        // imageOptions:{
        //     imageSize:0.6,
        //     margin:0
        //   }
      });

      qrCode.append(document.getElementById("canvas"));
      waitForCanvasToLoad(passQRToSave);
    }

    function passQRToSave(canvasElement) {
        if (canvasElement) {
            var img = canvasElement.toDataURL('image/png');
            // The rest of your code
            google.script.run.withSuccessHandler(function(fileName) {
            // Change the border color to green on success
            generateNextQR();
        }).withFailureHandler(function(error) {
            // Display an alert with the error message
            $('#message').text("ERROR SAVING: "+error);
            alert("Error saving QR code to Drive: " + error);
        }).saveQRCodeToDrive(img, dataArray[counter].Name, dataArray[counter].Row);
        } else {
            alert("QR code not found. Please generate the QR code first.");
        }
    }
  
    function generateNextQR() {
      counter++;
      generateQR();
    }
    </script>
</body>
</html>
